<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Sagnik Dutta — Blog (Read)</title>
  <link rel="stylesheet" href="assets/css/style.css">
  <style>
    /* Hide debug area from visitors */
    #debug-area {
      display: none !important;
    }
  </style>
</head>
<body>
  <header class="site-header">
    <div class="container">
      <h1 class="brand">Sagnik Dutta</h1>
      <nav class="main-nav">
        <a href="index.html">Films</a>
        <a href="about.html">About me</a>
        <a href="read.html" aria-current="page">Read</a>
      </nav>
    </div>
  </header>

  <main class="container read-wrap" id="read-root">
    <section class="read-main">
      <div style="display:flex;align-items:center;justify-content:space-between">
        <h2 id="page-title">Read</h2>
        <div class="small muted">Showing <span id="posts-count">0</span> posts</div>
      </div>

      <div class="search-row">
        <input id="search-input" class="search-input" placeholder="Search blog..." />
        <button id="clear-search" class="btn">Clear</button>
      </div>

      <div id="posts-list"></div>

      <div style="margin-top:14px">
        <button id="load-more" class="btn">Load more</button>
        <button id="retry-load" class="btn">Retry loading posts</button>
      </div>

      <!-- Debug area hidden by default -->
      <div id="debug-area">
        <div id="debug-message"></div>
        <div id="debug-log" aria-hidden="true"></div>
      </div>
    </section>

    <aside class="read-sidebar">
      <!-- Sidebar content here -->
    </aside>
  </main>

  <footer class="site-footer container">
    © 2025 SAGNIK DUTTA. ALL RIGHTS RESERVED
  </footer>

  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js" defer></script>
  <script>
    window.addEventListener('DOMContentLoaded', () => {
      const postsList = document.getElementById('posts-list');
      const postsCountEl = document.getElementById('posts-count');
      const searchInput = document.getElementById('search-input');
      const clearSearchBtn = document.getElementById('clear-search');
      const loadMoreBtn = document.getElementById('load-more');
      const retryLoadBtn = document.getElementById('retry-load');
      const debugLog = document.getElementById('debug-log');
      const debugMessage = document.getElementById('debug-message');

      let posts = [];
      let filtered = [];
      let visibleCount = 5;

      // Modified logDebug — writes to console always, UI only when debug is visible
      function logDebug(...args) {
        console.log(...args); // Always log to console
        const debugArea = document.getElementById('debug-area');
        if (debugArea && debugArea.style.display !== 'none') {
          debugLog.textContent += args
            .map(a => typeof a === 'object' ? JSON.stringify(a) : String(a))
            .join(' ') + '\n';
          debugLog.scrollTop = debugLog.scrollHeight;
        }
      }

      async function tryFetchJson(url) {
        try {
          const res = await fetch(url, {cache: 'no-store'});
          logDebug(`FETCH ${url} => ${res.status}`);
          if (!res.ok) return { ok:false, status: res.status };
          const data = await res.json();
          return { ok:true, data };
        } catch (err) {
          logDebug(`FETCH ${url} => ERROR: ${err.message}`);
          return { ok:false, error: err };
        }
      }

      async function loadPosts() {
        posts = [];
        debugLog.textContent = '';
        debugMessage.innerHTML = '';

        const idx = await tryFetchJson('posts/index.json');
        if (idx.ok) {
          const filesOrPosts = idx.data;
          if (Array.isArray(filesOrPosts) && typeof filesOrPosts[0] === 'string') {
            for (const file of filesOrPosts) {
              const r = await tryFetchJson(`posts/${file}`);
              if (r.ok) {
                if (Array.isArray(r.data)) posts.push(...r.data); 
                else posts.push(r.data);
              }
            }
          } else if (Array.isArray(filesOrPosts) && typeof filesOrPosts[0] === 'object') {
            posts = filesOrPosts;
          } else if (filesOrPosts && Array.isArray(filesOrPosts.files)) {
            for (const file of filesOrPosts.files) {
              const r = await tryFetchJson(`posts/${file}`);
              if (r.ok) {
                if (Array.isArray(r.data)) posts.push(...r.data); 
                else posts.push(r.data);
              }
            }
          }
        } else {
          const r2 = await tryFetchJson('posts.json');
          if (r2.ok) {
            if (Array.isArray(r2.data)) posts = r2.data;
            else if (Array.isArray(r2.data.posts)) posts = r2.data.posts;
            else if (typeof r2.data === 'object') posts = [r2.data];
          }
        }

        posts.forEach(p => p.dateObj = new Date(p.date));
        posts.sort((a,b) => b.dateObj - a.dateObj);

        renderPosts();
      }

      function renderPosts() {
        const q = (searchInput.value || '').toLowerCase();
        filtered = posts.filter(p => p.title.toLowerCase().includes(q));
        postsCountEl.textContent = filtered.length;
        const toShow = filtered.slice(0, visibleCount);

        postsList.innerHTML = '';
        toShow.forEach(p => {
          const card = document.createElement('div');
          card.className = 'post-card';
          card.innerHTML = `<h3>${p.title}</h3><div>${p.date}</div>`;
          postsList.appendChild(card);
        });
      }

      searchInput.addEventListener('input', () => { visibleCount = 5; renderPosts(); });
      clearSearchBtn.addEventListener('click', () => { searchInput.value = ''; visibleCount = 5; renderPosts(); });
      loadMoreBtn.addEventListener('click', () => { visibleCount += 5; renderPosts(); });
      retryLoadBtn.addEventListener('click', () => loadPosts());

      loadPosts();
    });
  </script>
</body>
</html>
